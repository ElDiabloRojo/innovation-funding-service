<!DOCTYPE html>
<html lang="en" class="govuk-template" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <th:block th:insert="fragments/layout :: head" th:with="pageTitle='Application team'" />
</head>
<body class="govuk-template__body">
<th:block th:insert="fragments/layout :: body-start" />
<th:block th:insert="fragments/layout :: global-header" />

<div class="govuk-width-container">
    <th:block th:insert="fragments/layout :: phase-banner" />

    <th:block th:insert="fragments/layout :: header-sub"
              th:with="linkTitle='Application overview',linkClass='link-back',linkUrl=@{/application/{applicationId}(applicationId=${model.applicationId})}" />

    <main class="govuk-main-wrapper" id="main-content" role="main">

        <div th:if="${#fields.hasErrors('${form.*}')}" class="govuk-error-summary"
             aria-labelledby="error-summary-title"
             role="alert"
             tabindex="-1"
             data-module="error-summary">
            <h2 class="govuk-error-summary__title" id="error-summary-title">There is a problem</h2>
            <th:block th:insert="fragments/elements :: error-summary-list(form)" />
        </div>

        <th:block th:insert="fragments/layout :: page-title"
                  th:with="pageTitle='Application team',subTitle=${model.applicationName},size='govuk-heading-xl'"/>

        <form th:action="@{${#ifsUtil.formPostUri(#httpServletRequest)}}" th:object="${form}" novalidate="novalidate"
              method="post">
            <th:block th:each="organisation: ${model.organisations}">
                <h2 class="govuk-heading-m govuk-!-margin-bottom-0">
                    <th:block th:text="${organisation.name}"></th:block>
                    <th:block th:if="${organisation.lead}">(Lead)</th:block>
                </h2>
                <table class="govuk-table"
                       th:classappend="${organisation.editable and !model.readOnly ? 'govuk-!-margin-bottom-2' : ''}">
                    <thead class="govuk-table__head">
                    <tr class="govuk-table__row">
                        <th scope="col" class="govuk-table__header larger-cols">Name</th>
                        <th scope="col" class="govuk-table__header">Email</th>
                        <th scope="col" class="govuk-table__header width-200"><span
                            class="govuk-visually-hidden">Remove</span></th>
                    </tr>
                    </thead>
                    <tbody class="govuk-table__body">
                    <tr th:each="row : ${organisation.rows}"
                        class="govuk-table__row">
                        <td class="govuk-table__cell"
                            th:text="${row.name}"
                            th:classappend="${row.invite ? 'hint' : ''}"></td>
                        <td class="govuk-table__cell"
                            th:text="${row.email}"
                            th:classappend="${row.invite ? 'hint' : ''}"></td>
                        <td class="govuk-table__cell"
                            th:classappend="${row.invite ? 'hint' : ''}">
                            <th:block th:if="${organisation.editable and !model.readOnly and !row.lead}">
                                <!-- /* TODO Resend invite
                                <th:block th:if="${row.invite}">
                                    <button class="button-clear govuk-!-margin-right-1" type="submit"
                                            name="resend-invite" th:value="${row.id}">Resend invite
                                    </button>
                                    <span>|</span>
                                </th:block>
                                */ -->

                                <th:block th:unless=${organisation.singleUserRemaining}>
                                    <th:block th:if="${!row.invite and model.loggedInUserId != row.id}">
                                        <th:block th:insert="fragments/modals :: modal-application-team-remove-user (${row})" />
                                        <a th:attr="data-js-modal=${'modal-application-team-remove-' + row.id}"
                                           href="/"
                                           class="govuk-link">Remove</a>
                                    </th:block>
                                    <th:block th:if="${row.invite}">
                                        <button class="button-clear govuk-!-margin-left-1" type="submit"
                                                name="remove-invite" th:value="${row.id}">Remove
                                        </button>
                                    </th:block>
                                </th:block>
                                <th:block th:if=${organisation.singleUserRemaining}>
                                    <th:block th:insert="fragments/modals :: modal-application-team-remove-organisation (${organisation}, ${row})" />
                                    <a th:attr="data-js-modal=${'modal-application-team-remove-organisation-' + organisation.id}"
                                       href="/"
                                       class="govuk-link">Remove organisation</a>
                                </th:block>
                            </th:block>
                            <th:block th:if="${row.lead}">Lead applicant</th:block>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <table th:id="${'invite-user-' + organisation.id}" th:if="${organisation.editable and !model.readOnly}"
                       class="govuk-table govuk-!-margin-bottom-2"
                       th:attr="aria-hidden=${organisation.openAddTeamMemberForm} ? 'false' : 'true'">
                    <thead class="govuk-table__head">
                    <tr class="govuk-table__row">
                        <th scope="col" class="govuk-table__header govuk-visually-hidden">Name</th>
                        <th scope="col" class="govuk-table__header govuk-visually-hidden">Email</th>
                        <th scope="col" class="govuk-table__header govuk-visually-hidden">Invite</th>
                        <th scope="col" class="govuk-table__header smaller-col govuk-visually-hidden">Remove</th>
                    </tr>
                    </thead>
                    <tbody class="govuk-table__body">
                    <tr class="govuk-table__row form-group-row-validated"
                        th:classappend="((${#fields.hasErrors('name')}) or (${#fields.hasErrors('email')})) ? 'govuk-form-group--error'">
                        <td class="govuk-table__cell govuk-form-group"
                            th:classappend="${#fields.hasErrors('name')} ? 'govuk-form-group--error'">
                            <label class="govuk-label govuk-label--s" for="name">
                                Name
                            </label>
                            <th:block th:if="${#fields.hasErrors('name')}">
                                <span class="govuk-error-message" th:each="err : ${#fields.errors('name')}"
                                      th:text="${err}"/>
                            </th:block>
                            <input id="name"
                                   th:field="*{name}"
                                   th:errorclass="govuk-input--error"
                                   class="govuk-input govuk-input--width-30"
                                   type="text"
                                   required="required"
                                   th:disabled="${!organisation.openAddTeamMemberForm}"
                                   th:attr="data-required-errormessage=#{validation.standard.name.required}"/>
                        </td>
                        <td class="govuk-table__cell govuk-form-group"
                            th:classappend="${#fields.hasErrors('email')} ? 'govuk-form-group--error'">
                            <label class="govuk-label govuk-label--s" for="email">
                                Email
                            </label>
                            <th:block th:if="${#fields.hasErrors('email')}">
                                <span class="govuk-error-message" th:each="err : ${#fields.errors('email')}"
                                      th:text="${err}"/>
                            </th:block>
                            <input id="email"
                                   th:field="*{email}"
                                   th:errorclass="govuk-input--error"
                                   class="govuk-input govuk-input--width-30"
                                   type="email"
                                   required="required"
                                   th:disabled="${!organisation.openAddTeamMemberForm}"
                                   th:attr="data-required-errormessage=#{validation.invite.email.format.required}"/>
                        </td>
                        <td class="govuk-table__cell">
                            <button th:name="${organisation.existing ? 'invite-to-existing-organisation' : 'invite-to-organisation'}"
                                    class="govuk-button govuk-!-margin-top-6"
                                    th:value="${organisation.id}">
                                Invite to application
                            </button>
                        </td>
                        <td class="govuk-table__cell">
                            <button name="close-add-team-member-form"
                                    class="button-clear govuk-!-margin-top-6 govuk-!-margin-left-6"
                                    th:attr="data-hide-form=${'invite-user-' + organisation.id}">
                                Remove
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <th:block th:if="${organisation.editable and !model.readOnly}">
                    <p class="govuk-body">
                        <button name="add-team-member"
                                th:value="${organisation.id}"
                                class="button-clear"
                                th:attr="data-show-form=${'invite-user-' + organisation.id},
                                         aria-hidden=${organisation.openAddTeamMemberForm} ? 'true' : 'false'">
                            Add team member
                        </button>
                    </p>
                </th:block>
            </th:block>


            <a th:href="@{/application/{applicationId}/form/question/{questionId}/team/new-organisation(applicationId=${model.applicationId},questionId(model.questionId))}"
               class="button-secondary">Add a partner organisation</a>
            <div class="form-footer govuk-!-margin-top-6" th:if="${model.canMarkAsComplete}">
                <!--/* 'Mark as complete' / 'Edit' links */-->
                <th:block th:insert="question-type/form-elements :: form-mark-as-complete-buttons (model=${model}, pageType='research category')"/>
            </div>
            <input type="hidden" id="cacheTest" value=""/>

            <a href="/"
               class="button-secondary">Return to application overview</a>
        </form>

        <th:block th:insert="fragments/layout :: main-content-end" />
    </main>
</div>
<th:block th:insert="fragments/layout :: footer" />
<th:block th:insert="fragments/layout :: body-end" />
<th:block th:insert="fragments/service-layout :: body-end" />
</body>
</html>

ALTER TABLE application_finance
    ADD COLUMN employees bigint(20),
    ADD COLUMN turnover double,
    ADD COLUMN financial_year_end date,
    ADD COLUMN annual_turnover double,
    ADD COLUMN annual_profits double,
    ADD COLUMN annual_export double,
    ADD COLUMN research_and_development double;

update application_finance af
    inner join application app on af.application_id = app.id
    inner join competition comp on app.competition = comp.id
    -- Turnover
    inner join form_input turnover_input on turnover_input.form_input_type_id = 24 and turnover_input.competition_id = comp.id
    left join form_input_response turnover_response on turnover_response.form_input_id = turnover_input.id and turnover_response.application_id=app.id
    left join process_role turnover_updated_by on turnover_updated_by.id = turnover_response.updated_by_id and turnover_updated_by.organisation_id = af.organisation_id
    -- Employees
    inner join form_input employees_input on employees_input.form_input_type_id = 25 and employees_input.competition_id = comp.id
    left join form_input_response employees_response on employees_response.form_input_id = employees_input.id and employees_response.application_id=app.id
    left join process_role employees_updated_by on employees_updated_by.id = employees_response.updated_by_id and employees_updated_by.organisation_id = af.organisation_id
set af.employees=employees_response.value,
    af.turnover=turnover_response.value
where comp.include_project_growth_table = 0;


update application_finance af
    inner join application app on af.application_id = app.id
    inner join competition comp on app.competition = comp.id
    -- Financial year end
    inner join form_input year_end_input on year_end_input.form_input_type_id = 26 and year_end_input.competition_id = comp.id
    left join form_input_response year_end_response on year_end_response.form_input_id = year_end_input.id and year_end_response.application_id=app.id
    left join process_role year_end_updated_by on year_end_updated_by.id = year_end_response.updated_by_id and year_end_updated_by.organisation_id = af.organisation_id
    -- Employees
    inner join form_input employees_input on employees_input.form_input_type_id = 28 and employees_input.competition_id = comp.id
    left join form_input_response employees_response on employees_response.form_input_id = employees_input.id and employees_response.application_id=app.id
    left join process_role employees_updated_by on employees_updated_by.id = employees_response.updated_by_id and employees_updated_by.organisation_id = af.organisation_id
    -- Annual turnover
    inner join form_input annual_turnover_input on annual_turnover_input.form_input_type_id = 27 and annual_turnover_input.description = 'Annual turnover' and annual_turnover_input.competition_id = comp.id
    left join form_input_response annual_turnover_response on annual_turnover_response.form_input_id = annual_turnover_input.id and annual_turnover_response.application_id=app.id
    left join process_role annual_turnover_updated_by on annual_turnover_updated_by.id = annual_turnover_response.updated_by_id and annual_turnover_updated_by.organisation_id = af.organisation_id
    -- Annual turnover
    inner join form_input annual_profits_input on annual_profits_input.form_input_type_id = 27 and annual_profits_input.description = 'Annual profits' and annual_profits_input.competition_id = comp.id
    left join form_input_response annual_profits_response on annual_profits_response.form_input_id = annual_profits_input.id and annual_profits_response.application_id=app.id
    left join process_role annual_profits_updated_by on annual_profits_updated_by.id = annual_profits_response.updated_by_id and annual_profits_updated_by.organisation_id = af.organisation_id
    -- Annual turnover
    inner join form_input annual_export_input on annual_export_input.form_input_type_id = 27 and annual_export_input.description = 'Annual export' and annual_export_input.competition_id = comp.id
    left join form_input_response annual_export_response on annual_export_response.form_input_id = annual_export_input.id and annual_export_response.application_id=app.id
    left join process_role annual_export_updated_by on annual_export_updated_by.id = annual_export_response.updated_by_id and annual_export_updated_by.organisation_id = af.organisation_id
    -- Annual turnover
    inner join form_input research_and_development_input on research_and_development_input.form_input_type_id = 27 and research_and_development_input.description = 'Research and development spend' and research_and_development_input.competition_id = comp.id
    left join form_input_response research_and_development_response on research_and_development_response.form_input_id = research_and_development_input.id and research_and_development_response.application_id=app.id
    left join process_role research_and_development_updated_by on research_and_development_updated_by.id = research_and_development_response.updated_by_id and research_and_development_updated_by.organisation_id = af.organisation_id
set af.employees = employees_response.value,
    af.financial_year_end = date(concat(substring(year_end_response.value, 4, 4), '-', substring(year_end_response.value, 1, 2), '-01')),
    af.annual_turnover = annual_turnover_response.value,
    af.annual_profits = annual_profits_response.value,
    af.annual_export = annual_export_response.value,
    af.research_and_development = research_and_development_response.value
where comp.include_project_growth_table = 1;

ALTER TABLE project_finance
    ADD COLUMN employees bigint(20),
    ADD COLUMN turnover double,
    ADD COLUMN financial_year_end date,
    ADD COLUMN annual_turnover double,
    ADD COLUMN annual_profits double,
    ADD COLUMN annual_export double,
    ADD COLUMN research_and_development double;

update project_finance pf
    inner join project p on p.id = pf.project_id
    inner join application app on app.id = p.application_id
    inner join application_finance af on af.application_id = app.id and af.organisation_id = pf.organisation_id
set pf.employees = af.employees,
    pf.turnover =  af.turnover,
    pf.financial_year_end = af.financial_year_end,
    pf.annual_turnover = af.annual_turnover,
    pf.annual_profits = af.annual_profits,
    pf.annual_export = af.annual_export,
    pf.research_and_development = af.research_and_development;